name: Deploy to ECS with Terraform

on:
  # Trigger after successful Docker build
  workflow_run:
    workflows: ["build_and_push_docker_images"]
    types:
      - completed
    branches: ["main"]

  # Also trigger on Terraform-only changes
  push:
    branches: ["main"]
    paths:
      - 'terraform/**'
      - '!terraform/**/*.md'

  workflow_dispatch: # useful to deploy manually using custom image tags
    inputs:
      image_tag:
        description: "Optional custom project image tag for manual deploy"
        required: false
        type: string
      lambda_tag:
        description: "Optional custom Lambda image tag for manual deploy"
        required: false
        type: string

permissions:
  contents: read
  actions: read

jobs:
  skip-deploy:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - uses: actions/checkout@v3
      - name: Check for concurrent build
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            count=$(gh run list --workflow build.yml --commit ${{ github.sha }} --json status --jq 'length')

            if [ "$count" -gt 0 ]; then
              echo "Build workflow found for this commit. Skipping direct deploy (triggered by terraform files updated) to let workflow_run handle it."
              echo "skip=true" >> $GITHUB_OUTPUT
            else
              echo "No build workflow found (likely due to path filters). Proceeding with Terraform-only deploy."
              echo "skip=false" >> $GITHUB_OUTPUT
            fi
          else
            # workflow_run or workflow_dispatch: never skip here
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
  deploy:
    runs-on: ubuntu-latest
    needs: skip-deploy
    # Only run if workflow_run was successful, or if it's a direct push
    if: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || (github.event_name != 'workflow_run' && needs.skip-deploy.outputs.skip != 'true') }}
    steps:
      - uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Sync GitHub secrets to AWS Secrets Manager
      - name: Update AWS Secrets Manager
        run: |
          aws secretsmanager put-secret-value \
            --secret-id nzambe-staging-langfuse-secret-key \
            --secret-string "${{ secrets.LANGFUSE_SECRET_KEY }}"

          aws secretsmanager put-secret-value \
            --secret-id nzambe-staging-langfuse-public-key \
            --secret-string "${{ secrets.LANGFUSE_PUBLIC_KEY }}"

          aws secretsmanager put-secret-value \
            --secret-id nzambe-staging-langfuse-base-url \
            --secret-string "${{ secrets.LANGFUSE_BASE_URL }}"

          aws secretsmanager put-secret-value \
            --secret-id nzambe-staging-openai-api-key \
            --secret-string "${{ secrets.OPENAI_API_KEY }}"

          echo "✅ AWS Secrets Manager updated successfully"

      # Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      # Determine which image tags to use (project and Lambda)
      - name: Determine image tags
        id: image-tags
        run: |
          cd terraform/envs/staging
          terraform init > /dev/null

          # Determine PROJECT image tag
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.image_tag }}" ]]; then
            PROJECT_TAG="${{ inputs.image_tag }}"
            echo "Using manually provided project image tag: $PROJECT_TAG"
          elif [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            # Get the build-project job output from the workflow_run event
            PROJECT_TAG="sha-${{ github.event.workflow_run.head_sha }}"
            echo "Using newly built project image tag: $PROJECT_TAG"
          else
            # Terraform-only changes, get current tag from state
            echo "Fetching current project image tag from Terraform state..."
            CURRENT_TAG=$(terraform output -raw current_rag_server_image_tag 2>/dev/null || echo "")
            if [ -z "$CURRENT_TAG" ] || [ "$CURRENT_TAG" == "null" ]; then
              echo "❌ Error: No existing project image deployment found."
              exit 1
            fi
            PROJECT_TAG="$CURRENT_TAG"
            echo "Using current deployed project image tag: $PROJECT_TAG"
          fi

          # Determine LAMBDA image tag
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.lambda_tag }}" ]]; then
            LAMBDA_TAG="lambda-${{ inputs.lambda_tag }}"
            echo "Using manually provided Lambda image tag: $LAMBDA_TAG"
          elif [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            # Get the build-lambda job output from the workflow_run event
            LAMBDA_TAG="lambda-sha-${{ github.event.workflow_run.head_sha }}"
            echo "Using newly built Lambda image tag: $LAMBDA_TAG"
          else
            # Terraform-only changes, get current tag from state
            echo "Fetching current Lambda image tag from Terraform state..."
            CURRENT_LAMBDA_TAG=$(terraform output -raw current_lambda_image_tag 2>/dev/null || echo "")
            if [ -z "$CURRENT_LAMBDA_TAG" ] || [ "$CURRENT_LAMBDA_TAG" == "null" ]; then
              echo "❌ Error: No existing Lambda image deployment found."
              exit 1
            fi
            LAMBDA_TAG="$CURRENT_LAMBDA_TAG"
            echo "Using current deployed Lambda image tag: $LAMBDA_TAG"
          fi

          echo "project_tag=$PROJECT_TAG" >> $GITHUB_OUTPUT
          echo "lambda_tag=$LAMBDA_TAG" >> $GITHUB_OUTPUT

      # Deploy with Terraform
      - name: Deploy to ECS
        run: |
          cd terraform/envs/staging
          terraform init > /dev/null
          terraform apply -auto-approve \
            -var="rag_server_image_tag=${{ steps.image-tags.outputs.project_tag }}" \
            -var="lambda_image_tag=${{ steps.image-tags.outputs.lambda_tag }}"

          echo "✅ Deployed with image tags:"
          echo "  - Project: ${{ steps.image-tags.outputs.project_tag }}"
          echo "  - Lambda: ${{ steps.image-tags.outputs.lambda_tag }}"
